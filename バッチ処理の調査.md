# バッチ処理の調査

#### 1. 環境の準備

（パスは開発者の端末でのパスになります）

* ソースコード

```
E:\PROJECT\18_SFA\GIT\CODE\Iseki_SFA
```

*  classファイルのパス：

```
E:\PROJECT\18_SFA\GIT\CODE\Iseki_SFA\build\classes
```

* 試し用の java ファイル: 

```
E:\PROJECT\18_SFA\GIT\CODE\Iseki_SFA\src\Iseki_SFA\batch\Ginkoubetu_Print.java
```

* 試し用の classファイル:

```
E:\PROJECT\18_SFA\GIT\CODE\Iseki_SFA\build\classes\Iseki_SFA\batch\Ginkoubetu_Print.class
```

* Batch_Controller_2.javaを修正して、出力先は固定にする：

```
protected static final String OUT_PDF = "E:/OutPdf/";
```

* IsekiHok.iniを修正して、DBの接続先を入れる

```
RDB_DRV=oracle.jdbc.driver.OracleDriver
RDB_URL=jdbc:oracle:thin:@192.168.1.144:1521:orcl
RDB_USR=
RDB_PAS=
```

2. 必要なjarの準備

* ọdbc8.jar
* svf.jar
* deprecatedSun.jar
* servlet.jar
  

3. jdk 1.8で実行

```
E:\PROJECT\18_SFA\GIT\CODE\Iseki_SFA\build\classes>java -classpath "E:\PROJECT\18_SFA\GIT\CODE\Iseki_SFA\WebContent\WEB-INF\lib\ojdbc8.jar;E:\PROJECT\18_SFA\GIT\CODE\Iseki_SFA\WebContent\WEB-INF\lib\svf.jar;E:\PROJECT\18_SFA\KH\servlet.jar;" Iseki_SFA.batch.Ginkoubetu_Print
```

で実行したら

```
Exception in thread "main" java.lang.NoClassDefFoundError: sun/io/ByteToCharConverter
at jp.co.fit.vfreport.Def.getDefaultConverterName(Def.java:139)
at jp.co.fit.vfreport.Def.<clinit>(Def.java:134)
at jp.co.fit.vfreport.VR32MAIN.getMainProperties(VR32MAIN.java:56)
at jp.co.fit.vfreport.VR32MAIN.<init>(VR32MAIN.java:23)
at jp.co.fit.vfreport.Vrw32.<init>(Vrw32.java:35)
at Iseki_SFA.batch.Ginkoubetu_Print.OutPdf(Ginkoubetu_Print.java:169)
at Iseki_SFA.batch.Ginkoubetu_Print.doMain(Ginkoubetu_Print.java:56)
at Iseki_SFA.batch.Batch_Controller_2.<init>(Batch_Controller_2.java:64)
at Iseki_SFA.batch.Ginkoubetu_Print.<init>(Ginkoubetu_Print.java:39)
at Iseki_SFA.batch.Ginkoubetu_Print.main(Ginkoubetu_Print.java:34)
Caused by: java.lang.ClassNotFoundException: sun.io.ByteToCharConverter
```

java1.8からsun.io.xxx のclassが使えなくなるため、svfがclassを見つけないでエラーになりました。

deprecatedSun.jarを追加したら

```
E:\PROJECT\18_SFA\GIT\CODE\Iseki_SFA\build\classes>java -classpath "E:\PROJECT\18_SFA\GIT\CODE\Iseki_SFA\WebContent\WEB-INF\lib\ojdbc8.jar;E:\PROJECT\18_SFA\GIT\CODE\Iseki_SFA\WebContent\WEB-INF\lib\deprecatedSun.jar;E:\PROJECT\18_SFA\GIT\CODE\Iseki_SFA\WebContent\WEB-INF\lib\svf.jar;E:\PROJECT\18_SFA\KH\servlet.jar;" Iseki_SFA.batch.Ginkoubetu_Print
```

別なエラーが出ます

```
Exception in thread "main" java.lang.ExceptionInInitializerError
at jp.co.fit.vfreport.VR32MAIN.getMainProperties(VR32MAIN.java:56)
at jp.co.fit.vfreport.VR32MAIN.<init>(VR32MAIN.java:23)
at jp.co.fit.vfreport.Vrw32.<init>(Vrw32.java:35)
at Iseki_SFA.batch.Ginkoubetu_Print.OutPdf(Ginkoubetu_Print.java:169)
at Iseki_SFA.batch.Ginkoubetu_Print.doMain(Ginkoubetu_Print.java:56)
at Iseki_SFA.batch.Batch_Controller_2.<init>(Batch_Controller_2.java:64)
at Iseki_SFA.batch.Ginkoubetu_Print.<init>(Ginkoubetu_Print.java:39)
at Iseki_SFA.batch.Ginkoubetu_Print.main(Ginkoubetu_Print.java:34)
Caused by: java.lang.SecurityException: sealing violation: can't seal package sun.io: already loaded
```

調査した結果、sun.* はシステムのclassなので、勝手に上書きできません。
どうしてもシステムのクラスをカスタマイズしたい時、-Xbootclasspathのオプションをつければ上書きできます。

ーー  
参考URL  
https://stackoverflow.com/questions/33237422/what-effect-does-xbootclasspath-has-on-jdk-core-classes-and-when-it-is-required  
https://answers.ycrash.io/question/-what-is-java-boot-class-path--xbootclasspath?q=650  
https://www.ibm.com/docs/en/sdk-java-technology/8?topic=options-xbootclasspath  
ーー  
Xbootclasspath/pを使うと  

```
E:\PROJECT\18_SFA\GIT\CODE\Iseki_SFA\build\classes>java -Xbootclasspath/p:"E:\PROJECT\18_SFA\GIT\CODE\Iseki_SFA\WebContent\WEB-INF\lib\deprecatedSun.jar" -classpath "E:\PROJECT\18_SFA\GIT\CODE\Iseki_SFA\WebContent\WEB-INF\lib\ojdbc8.jar;E:\PROJECT\18_SFA\GIT\CODE\Iseki_SFA\WebContent\WEB-INF\lib\svf.jar;E:\PROJECT\18_SFA\KH\servlet.jar;" Iseki_SFA.batch.Ginkoubetu_Print
```

で別なエラーが出ます。

```
WARNING: Error while registering Oracle JDBC Diagnosability MBean.
java.lang.UnsatisfiedLinkError: sun.nio.ch.IOUtil.initIDs()V
at sun.nio.ch.IOUtil.initIDs(Native Method)
at sun.nio.ch.Util.load(Util.java:493)
at sun.nio.ch.IOUtil.<clinit>(IOUtil.java:351)
at sun.nio.ch.Util.<clinit>(Util.java:48)
at sun.nio.ch.FileChannelImpl.<clinit>(FileChannelImpl.java:1132)
at sun.management.ManagementFactoryHelper.getBufferPoolMXBeans(Unknown Source)
at java.lang.management.PlatformComponent$11.getMXBeans(Unknown Source)
at java.lang.management.PlatformComponent.getMXBeans(Unknown Source)
at java.lang.management.ManagementFactory.getPlatformMBeanServer(Unknown Source)
at oracle.jdbc.driver.OracleDriver.registerMBeans(OracleDriver.java:365)
at oracle.jdbc.driver.OracleDriver$1.run(OracleDriver.java:241)
at java.security.AccessController.doPrivileged(Native Method)
at oracle.jdbc.driver.OracleDriver.<clinit>(OracleDriver.java:237)
at java.lang.Class.forName0(Native Method)
at java.lang.Class.forName(Unknown Source)
at Iseki_SFA.isekihok.utility.DBAccess.getConnection(DBAccess.java:50)
at Iseki_SFA.batch.Batch_Controller_2.<init>(Batch_Controller_2.java:58)
at Iseki_SFA.batch.Ginkoubetu_Print.<init>(Ginkoubetu_Print.java:39)
at Iseki_SFA.batch.Ginkoubetu_Print.main(Ginkoubetu_Print.java:34)

Exception in thread "main" java.lang.NoClassDefFoundError: Could not initialize class sun.nio.ch.Util
```

Xbootclasspath/aを使うと

```
E:\PROJECT\18_SFA\GIT\CODE\Iseki_SFA\build\classes>java -Xbootclasspath/a:"E:\PROJECT\18_SFA\GIT\CODE\Iseki_SFA\WebContent\WEB-INF\lib\deprecatedSun.jar" -classpath "E:\PROJECT\18_SFA\GIT\CODE\Iseki_SFA\WebContent\WEB-INF\lib\ojdbc8.jar;E:\PROJECT\18_SFA\GIT\CODE\Iseki_SFA\WebContent\WEB-INF\lib\svf.jar;E:\PROJECT\18_SFA\KH\servlet.jar;" Iseki_SFA.batch.Ginkoubetu_Print
```

また別なエラーが出てきます。

```
Exception in thread "main" java.lang.NoSuchMethodError: sun.nio.cs.MS1252.getDecoderSingleByteMappings()Ljava/lang/String;
at sun.io.ByteToCharCp1252.<init>(ByteToCharCp1252.java:45)
at sun.reflect.NativeConstructorAccessorImpl.newInstance0(Native Method)
at sun.reflect.NativeConstructorAccessorImpl.newInstance(Unknown Source)
at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(Unknown Source)
at java.lang.reflect.Constructor.newInstance(Unknown Source)
at java.lang.Class.newInstance(Unknown Source)
at sun.io.Converters.newConverter(Converters.java:249)
at sun.io.Converters.newDefaultConverter(Converters.java:334)
at sun.io.ByteToCharConverter.getDefault(ByteToCharConverter.java:74)
at jp.co.fit.vfreport.Def.getDefaultConverterName(Def.java:139)
at jp.co.fit.vfreport.Def.<clinit>(Def.java:134)
at jp.co.fit.vfreport.VR32MAIN.getMainProperties(VR32MAIN.java:56)
at jp.co.fit.vfreport.VR32MAIN.<init>(VR32MAIN.java:23)
at jp.co.fit.vfreport.Vrw32.<init>(Vrw32.java:35)
at Iseki_SFA.batch.Ginkoubetu_Print.OutPdf(Ginkoubetu_Print.java:169)
at Iseki_SFA.batch.Ginkoubetu_Print.doMain(Ginkoubetu_Print.java:56)
at Iseki_SFA.batch.Batch_Controller_2.<init>(Batch_Controller_2.java:64)
at Iseki_SFA.batch.Ginkoubetu_Print.<init>(Ginkoubetu_Print.java:39)
at Iseki_SFA.batch.Ginkoubetu_Print.main(Ginkoubetu_Print.java:34)
```
sun.nio.cs.MS1252というクラスがないので、  
http://srcrr.com/java/oracle/openjdk/6/reference/sun/nio/cs/MS1252.html  
から取ってXbootclasspathで追加します。

```
E:\PROJECT\18_SFA\GIT\CODE\Iseki_SFA\build\classes>java -Xbootclasspath/p:"E:\PROJECT\18_SFA\GIT\CODE\Iseki_SFA\dm\sun.zip;" -Xbootclasspath/a:"E:\PROJECT\18_SFA\GIT\CODE\Iseki_SFA\WebContent\WEB-INF\lib\deprecatedSun.jar;E:\PROJECT\18_SFA\GIT\CODE\Iseki_SFA\dm\sun.zip;" -classpath "E:\PROJECT\18_SFA\GIT\CODE\Iseki_SFA\WebContent\WEB-INF\lib\ojdbc8.jar;E:\PROJECT\18_SFA\GIT\CODE\Iseki_SFA\WebContent\WEB-INF\lib\svf.jar;E:\PROJECT\18_SFA\KH\servlet.jar;" Iseki_SFA.batch.Ginkoubetu_Print
```

これでファイルを出力できるようになりました。

